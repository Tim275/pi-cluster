apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: fluent
  namespace: efk-system
spec:
  interval: 1h
  url: https://fluent.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluentd
  namespace: efk-system
spec:
  interval: 15m
  chart:
    spec:
      chart: fluentd
      # Update to a newer version
      version: "0.5.0"
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: efk-system
  values:
    # Disable PodSecurityPolicy
    podSecurityPolicy:
      enabled: false

    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi

    configMaps:
      output.conf: |-
        <match **>
          @type elasticsearch
          host elasticsearch-master
          port 9200
          logstash_format true
          logstash_prefix fluentd
          include_tag_key true
          tag_key @log_name
          flush_interval 1s
        </match>
