apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: logstash
  namespace: logging
spec:
  interval: 15m
  chart:
    spec:
      chart: logstash
      version: "7.17.3"
      sourceRef:
        kind: HelmRepository
        name: elastic
        namespace: logging
  values:
    image: "docker.elastic.co/logstash/logstash"
    imageTag: "7.17.3"

    logstashConfig:
      logstash.yml: |
        http.host: "0.0.0.0"
        path.data: /usr/share/logstash/data
        path.logs: /usr/share/logstash/logs
        log.level: info

    logstashPipeline:
      logstash.conf: |
        input {
          file {
            path => "/var/log/containers/*.log"
            exclude => ["/var/log/containers/*fluentd*", "/var/log/containers/*logstash*", "/var/log/containers/*elastic*", "/var/log/containers/*kibana*"]
            sincedb_path => "/usr/share/logstash/data/sincedb"
            start_position => "beginning"
            codec => "json_lines"
            tags => ["kubernetes"]
          }
        }

        filter {
          # Parse Kubernetes metadata from file path
          grok {
            match => { "path" => "/var/log/containers/%{DATA:pod_name}_%{DATA:namespace}_%{GREEDYDATA:container_name}\.log" }
          }
          
          # Handle and clean up the log field
          if [log] {
            # Skip logs with excessive backslashes (common issue with recursive logging)
            if [log] =~ /\\{5,}/ {
              drop {}
            }
            
            # Move log field to message
            mutate {
              rename => { "log" => "message" }
              add_field => {
                "kubernetes_namespace" => "%{namespace}"
                "kubernetes_pod" => "%{pod_name}"
                "kubernetes_container" => "%{container_name}"
              }
            }
          }
        }

        output {
          elasticsearch {
            hosts => ["elasticsearch-master:9200"]
            user => "${ELASTICSEARCH_USER}"
            password => "${ELASTICSEARCH_PASSWORD}"
            index => "%{[kubernetes_namespace]}-%{+YYYY.MM.dd}"
            template_overwrite => true
          }
        }

    extraVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: containers
        hostPath:
          path: /var/lib/docker/containers

    extraVolumeMounts:
      - name: varlog
        mountPath: /var/log
      - name: containers
        mountPath: /var/lib/docker/containers
        readOnly: true

    securityContext:
      runAsUser: 0 # Root access is required to read container logs
      privileged: true

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    extraEnv:
      - name: ELASTICSEARCH_USER
        valueFrom:
          secretKeyRef:
            name: elasticsearch-credentials
            key: username
      - name: ELASTICSEARCH_PASSWORD
        valueFrom:
          secretKeyRef:
            name: elasticsearch-credentials
            key: password
      - name: LS_JAVA_OPTS
        value: "-Xmx256m -Xms256m"
