---
- name: "Basis-Setup for Homelab (Enterprise-Ready & Safe)"
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: "ğŸ“Š System-Info anzeigen"
      debug:
        msg: |
          === {{ inventory_hostname }} BASIC SETUP ===
          ğŸ“ Pi Model: {{ ansible_lsb.description | default('Raspberry Pi') }}
          ğŸ’¾ RAM: {{ (ansible_memtotal_mb/1024)|round(1) }}GB
          ğŸ“¡ IP: {{ ansible_default_ipv4.address }}
          ğŸ¯ Rolle: {{ node_role | default('worker') }}
          
    - name: "ğŸ“¦ System updaten (Safe Mode)"
      apt:
        update_cache: yes
        upgrade: safe        # âœ… SICHER: Nur Security-Updates (nicht dist)
        autoremove: yes      # ğŸ§¹ AufrÃ¤umen alter Pakete
        
    - name: "ğŸ”§ Essential Pakete installieren (Enterprise-Ready)"
      apt:
        name:
          # ğŸ“Š System-Monitoring & Debug-Tools
          - htop          # ğŸ“ˆ Interaktiver Prozess-Monitor (CPU, RAM, Prozesse)
          - tree          # ğŸ“ Verzeichnis-Struktur schÃ¶n anzeigen
          - ncdu          # ğŸ’½ Disk-Usage-Analyzer (wo ist der Speicher hin?)
          - iotop         # ğŸ’¿ I/O-Monitoring (Storage-Performance Ã¼berwachen)
          
          # ğŸŒ Netzwerk & Download-Tools
          - curl          # ğŸŒ HTTP-Client fÃ¼r API-Calls (kubectl, helm, AWS S3)
          - wget          # ğŸ“¥ File-Download-Tool (Scripts, Binaries)
          - git           # ğŸ”„ Version Control (fÃ¼r Flux GitOps Repository)
          
          # ğŸ“ Development & Configuration-Tools
          - vim           # âœï¸ Text-Editor (YAML, Config-Files editieren)
          - jq            # ğŸ“Š JSON-Parser (kubectl output formatieren)
          - yq            # ğŸ“‹ YAML-Parser (Kubernetes-Manifests bearbeiten)
          
          # ğŸ” Kubernetes & Container-Essentials (CRITICAL fÃ¼r K3s/Cilium)
          - iptables      # ğŸ”¥ Firewall-Engine (K3s/Cilium Service-Mesh)
          - conntrack     # ğŸ”— Connection-Tracking (fÃ¼r Cilium eBPF)
          - ebtables      # ğŸŒ‰ Bridge-Firewall (Container-zu-Container-Networking)
          - ethtool       # ğŸ”§ Ethernet-Interface-Tool (Netzwerk-Tuning)
          - socat         # ğŸ“¡ Socket-Tool (K3s Port-Forwarding & Debugging)
          
        state: present
        
    - name: "ğŸ“ Raspberry Pi 5: cgroups fÃ¼r K3s aktivieren"
      lineinfile:
        path: /boot/firmware/cmdline.txt  # ğŸ“ Raspberry Pi 5 Pfad
        regexp: '^(.*)$'
        line: '\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1 swapaccount=1'
        backrefs: yes
      notify: reboot_pi
      
    - name: "ğŸŒ Container-Netzwerk-Module laden (Essential fÃ¼r Cilium)"
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay       # ğŸ“¦ Container-Overlay-Filesystem (fÃ¼r Pod-Storage)
        - br_netfilter  # ğŸŒ‰ Bridge-Netzwerk-Filter (Cilium eBPF braucht das)
        
    - name: "ğŸ“ Kernel-Module persistent machen"
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: "{{ item }}"
        create: yes
      loop:
        - overlay       # ğŸ“¦ FÃ¼r Container-Storage (Longhorn)
        - br_netfilter  # ğŸŒ‰ FÃ¼r Pod-zu-Pod-Kommunikation (Cilium)
        
    - name: "âš™ï¸ Kubernetes-Netzwerk-Einstellungen konfigurieren (Conservative)"
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-kubernetes.conf
        reload: yes
      loop:
        # âœ… STANDARD Kubernetes-Werte (Cilium-kompatibel)
        - key: "net.bridge.bridge-nf-call-iptables"
          value: "1"    # ğŸŒ‰ Bridge-Traffic durch iptables leiten
        - key: "net.bridge.bridge-nf-call-ip6tables"  
          value: "1"    # ğŸŒ‰ Auch fÃ¼r IPv6
        - key: "net.ipv4.ip_forward"
          value: "1"    # ğŸ“¡ IP-Forwarding (Router-Modus fÃ¼r Pods)
        - key: "vm.max_map_count"
          value: "262144"  # ğŸ—„ï¸ Memory-Mapping (fÃ¼r Longhorn Storage)
        # âœ… REDUZIERT fÃ¼r StabilitÃ¤t  
        - key: "fs.inotify.max_user_watches"
          value: "65536"   # ğŸ‘ï¸ File-Watching (fÃ¼r Flux GitOps) - konservativ
          
    - name: "ğŸš« Swap deaktivieren (K3s Requirement)"
      shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab
      register: swap_result
      changed_when: "'swapoff' in swap_result.stdout or swap_result.rc == 0"
      
    - name: "ğŸŒ¡ï¸ Raspberry Pi Temperatur-Monitoring einrichten"
      copy:
        dest: /usr/local/bin/pi-temp-check
        mode: '0755'
        content: |
          #!/bin/bash
          # ğŸŒ¡ï¸ Enterprise Homelab Temperature Check
          temp=$(vcgencmd measure_temp | cut -d= -f2 | cut -d\' -f1)
          echo "ğŸŒ¡ï¸ {{ inventory_hostname }}: ${temp}Â°C"
          if [ "$(echo "$temp > 70.0" | bc -l 2>/dev/null)" = "1" ]; then
            echo "âš ï¸ WARNING: High temperature on {{ inventory_hostname }}!"
          fi
          
    - name: "ğŸ“‹ NÃ¼tzliche Bash-Aliases fÃ¼r Homelab"
      blockinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        marker: "# {mark} ENTERPRISE HOMELAB ALIASES"
        block: |
          # ğŸ  Enterprise Homelab Aliases
          alias ll='ls -alF'                              # ğŸ“ Detaillierte Datei-Liste
          alias temp='vcgencmd measure_temp'              # ğŸŒ¡ï¸ Pi-Temperatur
          alias k='kubectl'                               # âš¡ Kubectl-Shortcut
          alias kgp='kubectl get pods -A'                 # ğŸ“¦ Alle Pods anzeigen
          alias kgs='kubectl get svc -A'                  # ğŸ”— Alle Services anzeigen
          alias kgn='kubectl get nodes -o wide'           # ğŸ–¥ï¸ Node-Status
          alias flux-status='flux get all -A'            # ğŸš€ Flux GitOps Status
          alias longhorn='kubectl get pods -n longhorn-system'  # ğŸ’¾ Longhorn Storage
          alias homelab-temp='sudo /usr/local/bin/pi-temp-check'  # ğŸŒ¡ï¸ Temp-Check
          
    - name: "âœ… Basic-Setup Summary"
      debug:
        msg: |
          ğŸ¯ SAFE BASIC SETUP COMPLETED auf {{ inventory_hostname }}!
          
          ğŸ“¦ Installierte Pakete:
          â€¢ System: htop, tree, ncdu, iotop
          â€¢ Netzwerk: curl, wget, git
          â€¢ Development: vim, jq, yq
          â€¢ Kubernetes: iptables, conntrack, ebtables, ethtool, socat
          
          âš™ï¸ Kubernetes-Vorbereitungen:
          â€¢ ğŸ“ cgroups aktiviert (Raspberry Pi 5)
          â€¢ ğŸŒ Container-Module geladen (overlay, br_netfilter)
          â€¢ ğŸ“¡ Netzwerk-Forwarding aktiviert
          â€¢ ğŸš« Swap deaktiviert
          â€¢ ğŸŒ¡ï¸ Temperatur-Monitoring eingerichtet
          
          ğŸ”„ REBOOT ERFORDERLICH fÃ¼r cgroup-Ã„nderungen!
          
          Nach Reboot bereit fÃ¼r:
          â€¢ K3s Installation
          â€¢ Cilium eBPF Networking  
          â€¢ Longhorn Distributed Storage
          â€¢ Velero + AWS S3 Backups
          â€¢ Enterprise Apps: Homepage, Linkding, Audiobookshelf, pgAdmin
          
  handlers:
    - name: reboot_pi
      reboot:
        reboot_timeout: 300
        msg: "ğŸ”„ Rebooting {{ inventory_hostname }} for cgroup & kernel changes"