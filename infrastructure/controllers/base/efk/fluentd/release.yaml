apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: fluent
  namespace: logging
spec:
  interval: 1h
  url: https://fluent.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluentd
  namespace: logging
spec:
  interval: 15m
  chart:
    spec:
      chart: fluentd
      version: "0.5.0"
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: logging
  values:
    # Run as a single deployment instead of DaemonSet
    kind: Deployment
    replicas: 1

    # Place on worker node (p2)
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - p2

    # Disable PodSecurityPolicy which is deprecated
    podSecurityPolicy:
      enabled: false

    # Resources for Raspberry Pi
    resources:
      limits:
        cpu: 200m
        memory: 300Mi
      requests:
        cpu: 100m
        memory: 200Mi

    # Elasticsearch output configuration
    configMaps:
      output.conf: |-
        <match **>
          @type elasticsearch
          host elasticsearch-master
          port 9200
          logstash_format true
          logstash_prefix fluentd
          include_tag_key true
          # Simple authentication without environment variables
          user elastic
          password changeme
          tag_key @log_name
          flush_interval 5s
          retry_limit 30
          retry_wait 10s
          max_retry_wait 30m
        </match>

      # Input configuration
      input.conf: |-
        <source>
          @type tail
          path /var/log/containers/*.log
          pos_file /var/log/fluentd-containers.log.pos
          tag kubernetes.*
          read_from_head true
          <parse>
            @type json
            time_format %Y-%m-%dT%H:%M:%S.%NZ
          </parse>
        </source>
